var KomenukaCanvas=function(h,o,d,i,g,k){var j,e,n,c,m;function a(q){var p;for(p in q){if(q.hasOwnProperty(p)){if(n[p]===undefined){n[p]=q[p]}else{if(n[p] instanceof Array){n[p][(n[p]).length]=q[p]}else{n[p]=[n[p],q[p]]}}}}m[m.length]=$.extend(true,{},n);l(n)}function l(r){var q,p;if(r===undefined||Object.keys(r).length===0){o.val("");d.val("");return}o.val(JSON.stringify(r));q=k.val();if((/^http:\/\//i).test(q)){q=q.substring(7);p=q.match(/^(img\.)?tiqav\.com\/([\w\d]+(\.jpg|\.gif|\.png)?)$/i)}if(p===null||p===undefined){d.val("http://komenuka.herokuapp.com/image/v1/"+encodeURIComponent(JSON.stringify(r))+"/"+encodeURIComponent(q))}else{d.val("http://komenuka.herokuapp.com/tiqav/v1/"+encodeURIComponent(JSON.stringify(r))+"/"+encodeURIComponent(p[2]))}}function b(B){var s,w,v,r,u,q,p,y,x,A,z,C;for(s in B){if(B.hasOwnProperty(s)){if(B[s].length){w=B[s]}else{w=[B[s]]}switch(s){case"rectangle":for(v=0,r=w.length;v<r;++v){u=w[v].color||"#fff";q=w[v].x1||0;p=w[v].x2||0;y=w[v].y1||0;x=w[v].y2||0;j.graphics.f(u).r(q,y,p-q,x-y).ef();h.update()}break;case"annotate":for(v=0,r=w.length;v<r;++v){A=w[v].text||"";q=w[v].x||0;y=w[v].y||0;C=w[v].size||"30";u=w[v].color||"#000000";z=new createjs.Text(A,C+"px Arial",u);z.x=q;z.y=y;h.addChild(z);h.update()}break;case"tategaki":for(v=0,r=w.length;v<r;++v){A=w[v].text||"";q=w[v].x||0;y=w[v].y||0;C=w[v].size||"30";u=w[v].color||"#000000";z=new createjs.TextEx(A,C+"px Arial",u);z.x=q;z.y=y;z.blockProgression="rl";z.textAlign="center";h.addChild(z);h.update()}break}}}}function f(){h.removeAllChildren();h.addChild(c);j=new createjs.Shape();h.addChild(j)}return{init:function(p){c=p;h.removeAllEventListeners();h.canvas.width=p.image.width;h.canvas.height=p.image.height;f();e=new createjs.Shape();e.alpha=0.7;h.addChild(e);h.update();n={};m=[];return this},publishRectangleEvents:function(){h.removeAllEventListeners();h.addEventListener("mousedown",function(r){var q=r.stageX|0,p=r.stageY|0;r.addEventListener("mousemove",function(s){var u=s.stageX|0,t=s.stageY|0;e.graphics.c().f("#"+i.val()).r(q,p,u-q,t-p).ef();h.update()});r.addEventListener("mouseup",function(v){var t,s,A,z,w={},u="#"+i.val(),y=v.stageX|0,x=v.stageY|0;e.graphics.c();j.graphics.f(u).r(q,p,y-q,x-p).ef();h.update();if(q<y){t=q;s=y}else{t=y;s=q}if(p<x){A=p;z=x}else{A=x;z=p}if(t!==0){w.x1=t}if(s!==0){w.x2=s}if(A!==0){w.y1=A}if(z!==0){w.y2=z}if(u!=="#FFFFFF"){w.color=u}a({rectangle:w})})})},publishAnnotateEvents:function(q,p){h.removeAllEventListeners();h.addEventListener("mousedown",function(s){if(q.val()){var t=p.val(),r="#"+g.val(),u=new createjs.Text(q.val(),t+"px Arial",r);u.x=s.stageX|0;u.y=s.stageY|0;u.alpha=0.6;h.addChild(u);h.update();s.addEventListener("mousemove",function(v){u.x=v.stageX|0;u.y=v.stageY|0;h.update()});s.addEventListener("mouseup",function(v){var y={text:u.text},x=v.stageX|0,w=v.stageY|0;u.x=x;u.y=w;u.alpha=1;h.update();if(x>=1){y.x=x}if(w>=1){y.y=w}if(t!=="30"){y.size=t}if(r!=="#000000"){y.color=r}a({annotate:y})})}})},publishTategakiEvents:function(q,p){h.removeAllEventListeners();h.addEventListener("mousedown",function(s){if(q.val()){var t=p.val(),r="#"+g.val(),u=new createjs.TextEx(q.val(),t+"px Arial",r);u.x=s.stageX|0;u.y=s.stageY|0;u.alpha=0.6;u.blockProgression="rl";u.textAlign="center";h.addChild(u);h.update();s.addEventListener("mousemove",function(v){u.x=v.stageX|0;u.y=v.stageY|0;h.update()});s.addEventListener("mouseup",function(v){var y={text:u.text},x=v.stageX|0,w=v.stageY|0;u.x=x;u.y=w;u.alpha=1;h.update();if(x>=1){y.x=x}if(w>=1){y.y=w}if(t!=="30"){y.size=t}if(r!=="#000000"){y.color=r}a({tategaki:y})})}})},publishSpuitEvents:function(){h.removeAllEventListeners();h.addEventListener("mousedown",function(s){var r=h.canvas.getContext("2d").getImageData(s.stageX|0,s.stageY|0,1,1).data,q="#000",p=(r[0].toString(16)+r[1].toString(16)+r[2].toString(16)).toUpperCase();if(r[0]<128||r[1]<128||r[2]<128){q="#fff"}i.val(p);i.css({"background-color":"#"+p,color:q})})},undo:function(){if(m.length>0){f();h.addChild(e);h.update();m.pop();n=m[m.length-1]||{};b(n);l(n)}}}};