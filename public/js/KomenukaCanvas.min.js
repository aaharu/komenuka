/*
 Copyright (c) 2013 aaharu
 https://raw.github.com/aaharu/komenuka/master/LICENSE
*/
var KomenukaCanvas=function(f,v,t,r,w,A){function u(a){for(var c in a)a.hasOwnProperty(c)&&(void 0===l[c]?l[c]=a[c]:l[c]instanceof Array?l[c][l[c].length]=a[c]:l[c]=[l[c],a[c]]);n[n.length]=$.extend(!0,{},l);x(l)}function x(a){var c,b;void 0===a||0===Object.keys(a).length?(v.val(""),t.val("")):(v.val(JSON.stringify(a)),c=A.val(),/^http:\/\//i.test(c)&&(c=c.substring(7),b=c.match(/^(img\.)?tiqav\.com\/([\w\d]+(\.jpg|\.gif|\.png)?)$/i)),null===b||void 0===b?t.val("http://komenuka.herokuapp.com/image/v1/"+
encodeURIComponent(JSON.stringify(a))+"/"+encodeURIComponent(c)):t.val("http://komenuka.herokuapp.com/tiqav/v1/"+encodeURIComponent(JSON.stringify(a))+"/"+encodeURIComponent(b[2])))}function y(){f.removeAllChildren();f.addChild(z);s=new createjs.Shape;f.addChild(s)}var s,p,l,z,n;return{init:function(a){z=a;f.removeAllEventListeners();f.canvas.width=a.image.width;f.canvas.height=a.image.height;y();p=new createjs.Shape;p.alpha=0.7;f.addChild(p);f.update();l={};n=[];return this},publishRectangleEvents:function(){f.removeAllEventListeners();
f.addEventListener("mousedown",function(a){var c=a.stageX|0,b=a.stageY|0;a.addEventListener("mousemove",function(e){var a=e.stageX|0;e=e.stageY|0;p.graphics.c().f("#"+r.val()).r(c,b,a-c,e-b).ef();f.update()});a.addEventListener("mouseup",function(a){var g,d,h,k={},m="#"+r.val();g=a.stageX|0;h=a.stageY|0;p.graphics.c();s.graphics.f(m).r(c,b,g-c,h-b).ef();f.update();c<g?a=c:(a=g,g=c);b<h?d=b:(d=h,h=b);0!==a&&(k.x1=a);0!==g&&(k.x2=g);0!==d&&(k.y1=d);0!==h&&(k.y2=h);"#FFFFFF"!==m&&(k.color=m);u({rectangle:k})})})},
publishAnnotateEvents:function(a,c){f.removeAllEventListeners();f.addEventListener("mousedown",function(b){if(a.val()){var e=c.val(),g="#"+w.val(),d=new createjs.Text(a.val(),e+"px Arial",g);d.x=b.stageX|0;d.y=b.stageY|0;d.alpha=0.6;f.addChild(d);f.update();b.addEventListener("mousemove",function(a){d.x=a.stageX|0;d.y=a.stageY|0;f.update()});b.addEventListener("mouseup",function(a){var b={text:d.text},c=a.stageX|0;a=a.stageY|0;d.x=c;d.y=a;d.alpha=1;f.update();1<=c&&(b.x=c);1<=a&&(b.y=a);"30"!==e&&
(b.size=e);"#000000"!==g&&(b.color=g);u({annotate:b})})}})},publishTategakiEvents:function(a,c){f.removeAllEventListeners();f.addEventListener("mousedown",function(b){if(a.val()){var e=c.val(),g="#"+w.val(),d=new createjs.TextEx(a.val(),e+"px Arial",g);d.x=b.stageX|0;d.y=b.stageY|0;d.alpha=0.6;d.blockProgression="rl";d.textAlign="center";f.addChild(d);f.update();b.addEventListener("mousemove",function(a){d.x=a.stageX|0;d.y=a.stageY|0;f.update()});b.addEventListener("mouseup",function(a){var b={text:d.text},
c=a.stageX|0;a=a.stageY|0;d.x=c;d.y=a;d.alpha=1;f.update();1<=c&&(b.x=c);1<=a&&(b.y=a);"30"!==e&&(b.size=e);"#000000"!==g&&(b.color=g);u({tategaki:b})})}})},publishSpuitEvents:function(){f.removeAllEventListeners();f.addEventListener("mousedown",function(a){a=f.canvas.getContext("2d").getImageData(a.stageX|0,a.stageY|0,1,1).data;var c="#000",b=(a[0].toString(16)+a[1].toString(16)+a[2].toString(16)).toUpperCase();if(128>a[0]||128>a[1]||128>a[2])c="#fff";r.val(b);r.css({"background-color":"#"+b,color:c})})},
undo:function(){if(0<n.length){y();f.addChild(p);f.update();n.pop();var a=l=n[n.length-1]||{},c,b,e,g,d,h,k,m,q;for(c in a)if(a.hasOwnProperty(c))switch(b=a[c].length?a[c]:[a[c]],c){case "rectangle":e=0;for(g=b.length;e<g;++e)d=b[e].color||"#fff",h=b[e].x1||0,k=b[e].x2||0,m=b[e].y1||0,q=b[e].y2||0,s.graphics.f(d).r(h,m,k-h,q-m).ef(),f.update();break;case "annotate":e=0;for(g=b.length;e<g;++e)k=b[e].text||"",h=b[e].x||0,m=b[e].y||0,q=b[e].size||"30",d=b[e].color||"#000000",d=new createjs.Text(k,q+
"px Arial",d),d.x=h,d.y=m,f.addChild(d),f.update();break;case "tategaki":for(e=0,g=b.length;e<g;++e)k=b[e].text||"",h=b[e].x||0,m=b[e].y||0,q=b[e].size||"30",d=b[e].color||"#000000",d=new createjs.TextEx(k,q+"px Arial",d),d.x=h,d.y=m,d.blockProgression="rl",d.textAlign="center",f.addChild(d),f.update()}x(l)}}}};
