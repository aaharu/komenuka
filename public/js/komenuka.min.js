/*!
* komenuka
* Copyright (c) 2013 aaharu
* https://raw.github.com/aaharu/komenuka/master/LICENSE
*/
var komenuka;!function(a){var b=function(){function a(a,b,c){this._stage=a,this._$colorPicker1=b,this._$colorPicker2=c}return a.prototype.init=function(a){this._image=a,this._stage.removeAllEventListeners(),this._stage.canvas.width=a.image.width,this._stage.canvas.height=a.image.height,this.clear(),this._overlay=new window.createjs.Shape,this._overlay.alpha=.7,this._stage.addChild(this._overlay),this._stage.update(),this._jsonObj={},this._jsonObjHistory=[]},a.prototype.publishRectangleEvents=function(){var a=this;this._stage.removeAllEventListeners(),this._stage.addEventListener("mousedown",function(b){var c=0|b.stageX,d=0|b.stageY;b.addEventListener("mousemove",function(b){var e=0|b.stageX,f=0|b.stageY;a._overlay.graphics.c().f("#"+a._$colorPicker1.val()).r(c,d,e-c,f-d).ef(),a._stage.update()}),b.addEventListener("mouseup",function(b){var e,f,g,h,i={},j="#"+a._$colorPicker1.val(),k=0|b.stageX,l=0|b.stageY;a._overlay.graphics.c(),a._shape.graphics.f(j).r(c,d,k-c,l-d).ef(),a._stage.update(),k>c?(e=c,f=k):(e=k,f=c),l>d?(g=d,h=l):(g=l,h=d),0!==e&&(i.x1=e),0!==f&&(i.x2=f),0!==g&&(i.y1=g),0!==h&&(i.y2=h),"#FFFFFF"!==j&&(i.color=j),a.updateJson({rectangle:i})})})},a.prototype.publishAnnotateEvents=function(a,b){var c=this;this._stage.removeAllEventListeners(),this._stage.addEventListener("mousedown",function(d){if(a.val()){var e=b.val(),f="#"+c._$colorPicker2.val(),g=new window.createjs.Text(a.val(),e+"px Arial",f);g.x=0|d.stageX,g.y=0|d.stageY,g.alpha=.6,c._stage.addChild(g),c._stage.update(),d.addEventListener("mousemove",function(a){g.x=0|a.stageX,g.y=0|a.stageY,c._stage.update()}),d.addEventListener("mouseup",function(a){var b={text:g.text},d=0|a.stageX,h=0|a.stageY;g.x=d,g.y=h,g.alpha=1,c._stage.update(),d>=1&&(b.x=d),h>=1&&(b.y=h),"30"!==e&&(b.size=e),"#000000"!==f&&(b.color=f),c.updateJson({annotate:b})})}})},a.prototype.publishTategakiEvents=function(a,b){var c=this;this._stage.removeAllEventListeners(),this._stage.addEventListener("mousedown",function(d){if(a.val()){var e=b.val(),f="#"+c._$colorPicker2.val(),g=new window.createjs.Text(a.val(),e+"px Arial",f);g.x=0|d.stageX,g.y=0|d.stageY,g.alpha=.6,g.blockProgression="rl",g.textAlign="center",c._stage.addChild(g),c._stage.update(),d.addEventListener("mousemove",function(a){g.x=0|a.stageX,g.y=0|a.stageY,c._stage.update()}),d.addEventListener("mouseup",function(a){var b={text:g.text},d=0|a.stageX,h=0|a.stageY;g.x=d,g.y=h,g.alpha=1,c._stage.update(),d>=1&&(b.x=d),h>=1&&(b.y=h),"30"!==e&&(b.size=e),"#000000"!==f&&(b.color=f),c.updateJson({tategaki:b})})}})},a.prototype.publishSpuitEvents=function(){var a=this;this._stage.removeAllEventListeners(),this._stage.addEventListener("mousedown",function(b){var c=a._stage.canvas.getContext("2d").getImageData(0|b.stageX,0|b.stageY,1,1).data,d="#000",e=(c[0].toString(16)+c[1].toString(16)+c[2].toString(16)).toUpperCase();(c[0]<128||c[1]<128||c[2]<128)&&(d="#fff"),a._$colorPicker1.val(e),a._$colorPicker1.css({"background-color":"#"+e,color:d})})},a.prototype.undo=function(){this._jsonObjHistory.length>0&&(this.clear(),this._stage.addChild(this._overlay),this._stage.update(),this._jsonObjHistory.pop(),this._jsonObj=this._jsonObjHistory[this._jsonObjHistory.length-1]||{},this.drawFromJson(this._jsonObj),this.updateHtml(this._jsonObj))},a.prototype.clear=function(){this._stage.removeAllChildren(),this._stage.addChild(this._image),this._shape=new window.createjs.Shape,this._stage.addChild(this._shape)},a.prototype.updateJson=function(a){var b;for(b in a)a.hasOwnProperty(b)&&(void 0===this._jsonObj[b]?this._jsonObj[b]=a[b]:this._jsonObj[b]instanceof Array?this._jsonObj[b][this._jsonObj[b].length]=a[b]:this._jsonObj[b]=[this._jsonObj[b],a[b]]);this._jsonObjHistory[this._jsonObjHistory.length]=$.extend(!0,{},this._jsonObj),this.updateHtml(this._jsonObj)},a.prototype.updateHtml=function(a){var b=new $.Event("komenuka:update");$(this._stage.canvas).trigger(b,a)},a.prototype.drawFromJson=function(a){var b,c,d,e,f,g,h,i,j,k,l,m;for(b in a)if(a.hasOwnProperty(b))switch(c=a[b].length?a[b]:[a[b]],b){case"rectangle":for(d=0,e=c.length;e>d;++d)f=c[d].color||"#fff",g=c[d].x1||0,h=c[d].x2||0,i=c[d].y1||0,j=c[d].y2||0,this._shape.graphics.f(f).r(g,i,h-g,j-i).ef(),this._stage.update();break;case"annotate":for(d=0,e=c.length;e>d;++d)k=c[d].text||"",g=c[d].x||0,i=c[d].y||0,m=c[d].size||"30",f=c[d].color||"#000000",l=new window.createjs.Text(k,m+"px Arial",f),l.x=g,l.y=i,this._stage.addChild(l),this._stage.update();break;case"tategaki":for(d=0,e=c.length;e>d;++d)k=c[d].text||"",g=c[d].x||0,i=c[d].y||0,m=c[d].size||"30",f=c[d].color||"#000000",l=new window.createjs.Text(k,m+"px Arial",f),l.x=g,l.y=i,l.blockProgression="rl",l.textAlign="center",this._stage.addChild(l),this._stage.update()}},a}();a.Canvas=b}(komenuka||(komenuka={}));