/*!
* Text
* Visit http://createjs.com/ for documentation, updates and examples.
*
* Copyright (c) 2010 gskinner.com, inc.
*
* Permission is hereby granted, free of charge, to any person
* obtaining a copy of this software and associated documentation
* files (the "Software"), to deal in the Software without
* restriction, including without limitation the rights to use,
* copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the
* Software is furnished to do so, subject to the following
* conditions:
*
* The above copyright notice and this permission notice shall be
* included in all copies or substantial portions of the Software.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
* OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
* NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
* HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
* WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
* FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
* OTHER DEALINGS IN THE SOFTWARE.
*/
(function(){if(typeof createjs.Text==="undefined"){setTimeout(argments.callee,100)}else{var a=createjs.Text.prototype;a.blockProgression="tb";a._drawText=function(o){var f=!!o;if(!f){o=this._getWorkingContext()}var p=String(this.text).split(/(?:\r\n|\r|\n)/);var m=this.lineHeight||this.getMeasuredLineHeight();if(this.blockProgression==="rl"){m=this.font.match(/(\d+)px /)[1]}var g=0;for(var e=0,b=p.length;e<b;e++){var n=o.measureText(p[e]).width;if(this.lineWidth===null||n<this.lineWidth){if(f){this._drawTextLine(o,p[e],g*m)}g++;continue}var k=p[e].split(/(\s)/);var h=k[0];for(var c=1,d=k.length;c<d;c+=2){if(o.measureText(h+k[c]+k[c+1]).width>this.lineWidth){if(f){this._drawTextLine(o,h,g*m)}g++;h=k[c+1]}else{h+=k[c]+k[c+1]}}if(f){this._drawTextLine(o,h,g*m)}g++}return g};a._drawTextLine=function(b,c,d){if(this.blockProgression==="rl"){this._drawVerticalTextLine(b,c,d)}else{if(this.outline){b.strokeText(c,0,d,this.maxWidth||65535)}else{b.fillText(c,0,d,this.maxWidth||65535)}}};a._drawVerticalTextLine=function(n,m,g){var c,b=m.length,k=this.lineHeight||this.getMeasuredLineHeight(),e,f=0,j=this.font.match(/(\d+)px /)[1],d;if(this.outline){for(c=0;c<b;++c){e=this._getCharType(m.charAt(c));switch(e){case"long":case"punctuation":case"small":case"parentheses":d=k;break;case"rotate-ascii":d=n.measureText(m.charAt(c)).width;break;default:d=k;break}f+=d;this._updateMatrix(n,e,-g,f,j,d);n.strokeText(m.charAt(c),-g,f)}}else{for(c=0;c<b;++c){e=this._getCharType(m.charAt(c));switch(e){case"long":case"punctuation":case"small":case"parentheses":d=k;break;case"rotate-ascii":d=n.measureText(m.charAt(c)).width;break;default:d=k;break}f+=d;this._updateMatrix(n,e,-g,f,j,d);n.fillText(m.charAt(c),-g,f)}}};a._updateMatrix=function(d,g,b,i,c,f){var e=this.getMatrix();e.appendMatrix(this._getVerticalTextMatrix(g,b,i,c,f));d.setTransform(e.a,e.b,e.c,e.d,e.tx,e.ty)};a._getCharType=function(b){if(/^[\u30FC\u301C\uFF5E\u2026\uFF1D]$/.test(b)){return"long"}else{if(/^[\u3001\uFF0C\u3002\uFF0E]$/.test(b)){return"punctuation"}else{if(/^[\u3041\u3043\u3045\u3047\u3049\u3083\u3085\u3087\u3063\u30A1\u30A3\u30A5\u30A7\u30A9\u30E3\u30E5\u30E7\u30C3]$/.test(b)){return"small"}else{if(/^[\u3008\u3009\u300A\u300B\u3010\u3011\u3016\u3017\uFF08\uFF09\uFF5F\uFF60\u300C\u300D\u300E\u300F\u3014\u3015\u3018\u3019\uFF5B\uFF5D\uFF1C\uFF1E\u201C\u201D\u2018\u2019]$/.test(b)){return"parentheses"}else{if(b==='"'||b==="'"||b==="-"||b==="/"||b===":"||b===";"||b==="<"||b==="="||b===">"||b==="["||b==="]"||b==="\\"||b==="{"||b==="|"||b==="}"||b==="("||b===")"){return"rotate-ascii"}}}}}return""};a._getVerticalTextMatrix=function(e,b,f,c,d){switch(e){case"long":return this._calculateMatrix(1,-1,270,-b+f+c*0.4,b-f-d*0.45);case"punctuation":return this._calculateMatrix(1,1,0,0.625*c,-0.625*d);case"small":return this._calculateMatrix(1,1,0,0.15*c,-0.15*d);case"parentheses":return this._calculateMatrix(1,1,90,-b+f+c*0.4,-b-f-d*0.4);case"rotate-ascii":return this._calculateMatrix(1,1,90,-b+f+c*0.8,-b-f-d*1.65);default:return new createjs.Matrix2D(1,0,0,1,0,0)}};a._calculateMatrix=function(i,h,f,e,c){var b=f*Math.PI/180;var g=Math.cos(b);var d=Math.sin(b);return new createjs.Matrix2D(i*g,h*d,-i*d,h*g,i*(g*e-d*c),h*(d*e+g*c))}}}());