var app,komenukaEditor;komenukaEditor={container:$("#main"),initEditor:function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n;return komenukaEditor.container.html(T.editor_edit.render()),d=$("#outjson"),e=$("#rectangleBtn"),a=$("#annotateBtn"),f=$("#tategakiBtn"),h=$("#undoBtn"),b=$("#drawText"),g=$("#textSize"),c=$("#komenukaUrlText"),k=new komenuka.Canvas(new createjs.Stage("canvas"),$("#colorPicker-r"),$("#colorPicker-w")),d.change(function(){var a;a=location.hash.substring(1),c.val("http://"+location.host+"/page/v1/"+encodeURIComponent(JSON.stringify(d.val()))+"/"+encodeURIComponent(a))}),$("#chkBtn").click(function(){return document.getElementById("komenukaImg").src=c.val().replace("page","image"),!1}),n=location.hash.substring(1),e.attr({disabled:"disabled"}),a.attr({disabled:"disabled"}),f.attr({disabled:"disabled"}),h.attr({disabled:"disabled"}),b.attr({disabled:"disabled"}),g.attr({disabled:"disabled"}),n?(m=n.match(/(https?):\/\/([^\/]+)(.*)/i),null===m?void alert("url error"):(n=m[1]+"://"+punycode.toASCII(m[2])+m[3],j=!1,(/^(.+)\.jpg\.to$/i.test(m[2])||/^http:\/\/gazoreply\.jp\/\d+\/[a-z\.0-9]+$/i.test(n))&&(j=!0),i=new Image,i.crossOrigin="Anonymous",i.onload=function(){jscolor.init(),k.init(new createjs.Bitmap(i)),d.val(""),e.removeAttr("disabled"),a.removeAttr("disabled"),f.removeAttr("disabled"),h.removeAttr("disabled")},j?$.get("//allow-any-origin.appspot.com/"+n,function(a){var b;return b=a.match(/<img.+src="([^"]+)".+>/i),null!==b?i.src="//allow-any-origin.appspot.com/"+b[1]:void 0}):(l=n.match(/^http:\/\/tiqav\.com\/([\w\d]+)$/i),null!==l?$.get("//allow-any-origin.appspot.com/http://api.tiqav.com/images/"+l[1]+".json",function(a){var b;b="http://img.tiqav.com/"+a.id+"."+a.ext,location.hash=b,n=b,i.src="//allow-any-origin.appspot.com/"+b}):i.src="//allow-any-origin.appspot.com/"+n),e.click(function(){b.attr({disabled:"disabled"}),g.attr({disabled:"disabled"}),k.publishRectangleEvents()}),a.click(function(){b.removeAttr("disabled"),g.removeAttr("disabled"),k.publishAnnotateEvents(b,g)}),f.click(function(){b.removeAttr("disabled"),g.removeAttr("disabled"),k.publishTategakiEvents(b,g)}),h.click(function(){k.undo()}),$("#spuitBtn").click(function(){k.publishSpuitEvents()}),void $("#canvas").on("komenuka:update",function(a,b){return void 0===b||0===Object.keys(b).length?(d.val(""),void c.val("")):(d.val(JSON.stringify(b)),void c.val("http://"+location.host+"/page/v1/"+encodeURIComponent(JSON.stringify(b))+"/"+encodeURIComponent(n)))}))):void alert("url error")}},""===location.hash?komenukaEditor.container.html(T.editor_search.render()):komenukaEditor.initEditor(),app=angular.module("app",[]),app.controller("EditorController",["$scope","$http",function(a,b){a.images=[],a.inputUrl=function(){null!=a.url&&(location.hash=a.url,komenukaEditor.initEditor())},a.searchTiqav=function(){null!=a.query&&(a.images=[{src:"/img/loading.gif"}],b.jsonp("http://api.tiqav.com/search.json?callback=JSON_CALLBACK&q="+a.query).success(function(b){var c;c=[],b.forEach(function(a){c.push({src:"http://img.tiqav.com/"+a.id+"."+a.ext})}),a.images=c}))},a.selectImage=function(a){null==a.target.src||/\/img\/loading\.gif$/.test(a.target.src)||(location.hash=a.target.src,komenukaEditor.initEditor())}}]);